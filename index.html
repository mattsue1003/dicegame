<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>無三不成禮-眼明手快 產生器</title>
    <!-- 載入 Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 jsPDF (用於產生 PDF) --><script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- 載入 html2canvas (用於將 HTML 轉為圖片) --><script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* 用於 PDF 產生的列印樣式 */
        #card-print-area {
            position: absolute;
            left: -9999px; /* 將其移出畫面外 */
            top: 0;
            background-color: #fff;
        }

        .pdf-page {
            width: 210mm; /* A4 寬度 */
            height: 297mm; /* A4 高度 */
            padding: 5mm; /* 頁邊距 */
            box-sizing: border-box;
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 2 欄 */
            grid-template-rows: repeat(4, 1fr);    /* 4 列 */
            gap: 5mm; /* 卡片間距 */
            page-break-after: always; /* 確保列印時分頁 */
            justify-items: center; /* 水平居中卡片 */
            align-items: center; /* 垂直居中卡片 */
            background-color: #fff; /* 確保背景白色 */
        }

        .pdf-card {
            width: 95mm; /* 卡片寬度 */
            height: 67mm; /* 卡片高度 */
            border: 1mm solid #000; /* 卡片外框：1mm 粗黑線 */
            border-radius: 12px; /* 卡片圓角 */
            padding: 5mm; /* 內邊距 */
            display: flex;
            flex-direction: column; /* 垂直排列 (圖上 文下) */
            align-items: center;
            justify-content: space-around; /* 均分空間 */
            box-sizing: border-box;
            background-color: #fff;
            overflow: hidden; /* 隱藏超出部分 */
        }

        /* PDF 卡片 - 圖片包裝區 */
        .pdf-card-img-wrapper {
            width: 55mm;
            height: 45mm;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 0.5mm solid #eee; /* 輕微內框 */
            border-radius: 8px;
            overflow: hidden;
            background: #f9f9f9;
        }
        
        /* PDF 卡片 - 圖片 (大小會由 inline-style 控制) */
        .pdf-card-img-wrapper img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: transform 0.3s;
        }
        
        /* PDF 卡片 - 文字包裝區 */
        .pdf-card-text-wrapper {
            font-size: 7mm; /* 放大字體 */
            font-weight: bold;
            color: #000;
            text-align: center;
            height: 10mm;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Arial', 'sans-serif'; /* 確保 PDF 能渲染 */
        }

        /* --- 骰子滾動動畫 --- */
        @keyframes spin {
            from { transform: rotate(0deg) scale(0.9); opacity: 0.8; }
            to { transform: rotate(360deg) scale(0.9); opacity: 0.8; }
        }
        .dice-spinning {
            animation: spin 0.4s linear infinite;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem; /* 放大問號 */
            color: #6b7280;
            font-weight: bold;
        }

        /* 落地動畫 */
        @keyframes land-effect {
            0% { transform: scale(1.0) rotate(0deg); opacity: 0.8; filter: blur(1px); }
            20% { transform: scale(1.2) rotate(-15deg) translateY(-10px); }
            40% { transform: scale(0.9) rotate(15deg); opacity: 0.6; filter: blur(2px); }
            60% { transform: scale(1.1) rotate(-5deg); filter: blur(1px); }
            80% { transform: scale(1.0) rotate(5deg) translateY(0); opacity: 1.0; }
            100% { transform: scale(1.0) rotate(0deg); filter: blur(0); }
        }
        .dice-land {
            animation: land-effect 0.7s ease-in-out;
        }

        /* 隱藏預設的檔案上傳 input */
        .hidden-input {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen p-4 md:p-8 flex items-center justify-center">

    <div class="max-w-4xl w-full mx-auto bg-white rounded-2xl shadow-xl p-6 md:p-8">
        
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">無三不成禮-眼明手快 產生器</h1>

        <!-- 新增的活動連結 -->
        <p class="text-center text-blue-600 mb-6 -mt-2">
            <a href="https://www.staging.accupass.com/event/2506051040161184370070?utm_source=web&utm_medium=search_result_%E6%A3%AE%E9%84%B0%E6%A4%8D%E7%99%82%E6%89%80&utm_campaign=accu_e_" target="_blank" rel="noopener noreferrer" class="hover:underline font-bold">
                邀請大家參加11/29（六）《讓你健康不失智的體智能》新書分享會
            </a>
        </p>

        <!-- 錯誤訊息提示框 --><div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4" role="alert">
            <strong class="font-bold">錯誤：</strong>
            <span class="block sm:inline" id="error-text"></span>
        </div>

        <!-- 載入中訊息提示框 --><div id="loading-message" class="hidden bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded-lg relative mb-4" role="status">
            <strong class="font-bold">處理中...</strong>
            <span class="block sm:inline" id="loading-text">正在產生 PDF 檔案，請稍候...</span>
        </div>

        <!-- 步驟 1: 上傳圖片 --><section id="upload-section">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">1. 上傳 8 個圖案</h2>
            <p class="text-gray-600 mb-4">
                請上傳 8 個不同的圖案，作為牌卡和骰子的內容。 (建議使用 1:1 比例、背景透明的 PNG 圖片)
            </p>
            <!-- 調整 grid 欄位 -->
            <div class="grid grid-cols-4 md:grid-cols-8 gap-3 md:gap-4 mb-6" id="upload-grid">
                <!-- 8 個上傳框將由 JS 動態產生 --></div>
            <button id="generate-btn" onclick="generateGame()" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-blue-700 transition duration-300 disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                產生遊戲
            </button>

            <!-- 遊戲規則 (上傳頁) -->
            <div class="rules-container mt-8 border border-gray-300 rounded-lg p-4 bg-gray-50">
                <h3 class="text-lg font-semibold text-gray-700 mb-3 text-center">遊戲玩法說明</h3>
                
                <div class="grid md:grid-cols-2 gap-4">
                    <!-- 玩法一 -->
                    <div>
                        <h4 class="font-bold text-gray-800">玩法一：無三不成禮 (拍牌玩法)</h4>
                        <ol class="list-decimal list-inside text-gray-600 space-y-1 text-sm md:text-base mt-2">
                            <li><strong>準備：</strong> 將 64 張卡片印出並黏貼，全部背面朝上洗勻，散開於桌面。</li>
                            <li><strong>回合：</strong> 玩家輪流翻開「一」張牌卡 (保持正面朝上)。</li>
                            <li><strong>搶奪：</strong> 當桌上出現「三張一樣**圖案**」的牌卡時 (**不看大小**)，所有玩家立刻去「拍」那三張牌。</li>
                            <li><strong>計分：</strong>
                                <ul class="list-disc list-inside ml-4">
                                    <li>一個玩家最多只能拍「兩」張 (得 2 分)。</li>
                                    <li>第三張必須由其他人拍 (得 1 分)。</li>
                                    <li>也可以三個人各拍一張 (各得 1 分)。</li>
                                </ul>
                            </li>
                            <li><strong>繼續：</strong> 拍到的牌卡拿走計分，遊戲繼續。**最後各圖案會剩下兩張 (不成對)。**</li>
                            <li><strong>勝利：</strong> 遊戲結束時，分數最高的玩家獲勝。</li>
                        </ol>
                    </div>
                    <!-- 玩法二 -->
                    <div>
                        <h4 class="font-bold text-gray-800">玩法二：眼明手快 (骰子玩法)</h4>
                        <ol class="list-decimal list-inside text-gray-600 space-y-1 text-sm md:text-base mt-2">
                            <li><strong>準備：</strong> 將 64 張卡片全部「正面朝上」散開於桌面。</li>
                            <li><strong>回合：</strong> 一位玩家點擊「擲骰！」按鈕。</li>
                            <li><strong>尋找：</strong> 擲骰會顯示「一個圖案」和「一個大小」。</li>
                            <li><strong>搶奪：</strong> 所有玩家立刻在桌上尋找「**兩**」張完全相符的牌卡 (例如：骰到 [蘋果] + [大]，就要找 [大蘋果] 的牌卡)。</li>
                            <li><strong>計分：</strong> 每搶到一張正確的卡片計 1 分。</li>
                            <li><strong>勝利：</strong> 可約定回合數 (例如 15 回合)，結束時分數最高的玩家獲勝。</li>
                        </ol>
                    </div>
                </div>
            </div>
        </section>

        <!-- 步驟 2: 遊玩 & 下載 -->
        <section id="play-section" class="hidden">
            
            <!-- 線上擲骰區 (玩法二) -->
            <div class="mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6 text-center">線上擲骰區 (玩法二)</h2>
                <div class="flex justify-center gap-4 mb-6">
                    <!-- 骰子將顯示在這裡 -->
                    <div id="dice-image" class="w-24 h-24 md:w-32 md:h-32 bg-white border-2 border-gray-300 rounded-lg shadow-md flex items-center justify-center p-2 transition-transform duration-300" title="圖案骰 (D8)"></div>
                    <div id="dice-size" class="w-24 h-24 md:w-32 md:h-32 bg-white border-2 border-gray-300 rounded-lg shadow-md flex items-center justify-center p-2 transition-transform duration-300" title="大小骰 (D4)"></div>
                </div>
                <button onclick="rollDice()" class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-green-700 transition duration-300 disabled:bg-gray-400 disabled:cursor-wait">
                    擲骰！
                </button>
            </div>

            <!-- 下載遊戲卡 -->
            <div class="border-t pt-6 mt-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6 text-center">下載/預覽 遊戲卡 (共 64 張)</h2>
                <div class="flex items-center justify-center mb-4">
                    <input type="checkbox" id="show-text-on-card" checked class="h-5 w-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500">
                    <label for="show-text-on-card" class="ml-2 block text-sm text-gray-700">在牌卡上顯示文字提示 (例如: "超大")</label>
                </div>
                <button onclick="downloadPDF()" class="w-full bg-red-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-red-700 transition duration-300">
                    下載 64 張卡片 (PDF)
                </button>
                 <p class="text-center text-sm text-gray-500 mt-3">
                    點擊後將自動下載 PDF (共 8 頁)。<br class="sm:hidden">建議印出後黏貼在厚的 A4 紙上再裁剪。
                </p>
            </div>

            <!-- 遊戲規則 (遊玩頁) -->
            <div class="rules-container mt-8 border border-gray-300 rounded-lg p-4 bg-gray-50">
                <h3 class="text-lg font-semibold text-gray-700 mb-3 text-center">遊戲玩法說明</h3>
                
                <div class="grid md:grid-cols-2 gap-4">
                    <!-- 玩法一 -->
                    <div>
                        <h4 class="font-bold text-gray-800">玩法一：無三不成禮 (拍牌玩法)</h4>
                        <ol class="list-decimal list-inside text-gray-600 space-y-1 text-sm md:text-base mt-2">
                            <li><strong>準備：</strong> 將 64 張卡片印出並黏貼，全部背面朝上洗勻，散開於桌面。</li>
                            <li><strong>回合：</strong> 玩家輪流翻開「一」張牌卡 (保持正面朝上)。</li>
                            <li><strong>搶奪：</strong> 當桌上出現「三張一樣**圖案**」的牌卡時 (**不看大小**)，所有玩家立刻去「拍」那三張牌。</li>
                            <li><strong>計分：</strong>
                                <ul class="list-disc list-inside ml-4">
                                    <li>一個玩家最多只能拍「兩」張 (得 2 分)。</li>
                                    <li>第三張必須由其他人拍 (得 1 分)。</li>
                                    <li>也可以三個人各拍一張 (各得 1 分)。</li>
                                </ul>
                            </li>
                            <li><strong>繼續：</strong> 拍到的牌卡拿走計分，遊戲繼續。**最後各圖案會剩下兩張 (不成對)。**</li>
                            <li><strong>勝利：</strong> 遊戲結束時，分數最高的玩家獲勝。</li>
                        </ol>
                    </div>
                    <!-- 玩法二 -->
                    <div>
                        <h4 class="font-bold text-gray-800">玩法二：眼明手快 (骰子玩法)</h4>
                        <ol class="list-decimal list-inside text-gray-600 space-y-1 text-sm md:text-base mt-2">
                            <li><strong>準備：</strong> 將 64 張卡片全部「正面朝上」散開於桌面。</li>
                            <li><strong>回合：</strong> 點擊上方的「擲骰！」按鈕。</li>
                            <li><strong>尋找：</strong> 擲骰會顯示「一個圖案」和「一個大小」。</li>
                            <li><strong>搶奪：</strong> 所有玩家立刻在桌上尋找「**兩**」張完全相符的牌卡 (例如：骰到 [蘋果] + [大]，就要找 [大蘋果] 的牌卡)。</li>
                            <li><strong>計分：</strong> 每搶到一張正確的卡片計 1 分。</li>
                            <li><strong>勝利：</strong> 可約定回合數 (例如 15 回合)，結束時分數最高的玩家獲勝。</li>
                        </ol>
                    </div>
                </div>
            </div>

            <!-- 設計者資訊 -->
            <footer class="mt-8 pt-6 border-t border-gray-200 text-center text-sm text-gray-500">
                <p class="mb-2">
                    遊戲設計：<a href="https://www.facebook.com/chungmenghsiu" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">鍾孟修 職能治療師</a>
                </p>
                <p class="mb-2">
                    追蹤粉絲專頁：<a href="https://www.facebook.com/profile.php?id=100063748491881#" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">鍾孟修Ｍatt-職能治療師</a>
                </p>
                <p>
                    新書：<a href="https://www.books.com.tw/products/0011022363?sloc=main" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">「讓你健康不失智的體智能」</a>
                </p>
                <!-- 移除頁尾的重複連結 -->
            </footer>

        </section>
    </div>

    <!-- 用於產生 PDF 的隱藏容器 --><div id="card-print-area"></div>

    <script>
        // --- 全域變數 ---
        const { jsPDF } = window.jspdf; // 取得 jsPDF
        let uploadedImages = new Array(8).fill(null); // 儲存 8 張圖片的 Base64 data URL
        
        // 定義 4 種大小
        const SIZES = [
            { name: '超大', scale: 1.0 },
            { name: '大',   scale: 0.8 },
            { name: '中',   scale: 0.6 },
            { name: '小',   scale: 0.4 }
        ];

        let cardCombinations = []; // 儲存 32 種組合 (8 images * 4 sizes)
        let isRolling = false; // 防止重複擲骰

        // --- 初始化 ---
        document.addEventListener('DOMContentLoaded', () => {
            createUploadBoxes();
        });

        // 隨機洗牌函式 (Fisher-Yates shuffle)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // 動態產生 8 個上傳框
        function createUploadBoxes() {
            const grid = document.getElementById('upload-grid');
            grid.innerHTML = ''; // 清空
            for (let i = 0; i < 8; i++) {
                grid.innerHTML += `
                    <label id="label-${i}" class="border-2 border-dashed border-gray-300 rounded-lg p-2 text-center cursor-pointer hover:bg-gray-50 aspect-square flex flex-col items-center justify-center text-gray-500">
                        <div id="preview-${i}" class="w-full h-full flex items-center justify-center">
                            <svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                            </svg>
                        </div>
                        <input type="file" accept="image/*" class="hidden-input" onchange="handleImageUpload(event, ${i})">
                    </label>
                `;
            }
        }

        // --- 圖片上傳處理 ---
        function handleImageUpload(event, index) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                showError('請上傳圖片檔案 (例如 .png, .jpg)。');
                return;
            }

            const reader = new FileReader();
            
            reader.onload = (e) => {
                const dataURL = e.target.result;
                uploadedImages[index] = dataURL;
                
                const previewBox = document.getElementById(`preview-${index}`);
                previewBox.innerHTML = `<img src="${dataURL}" class="max-w-full max-h-full object-contain rounded-md">`;
                
                checkAllImagesUploaded();
            };

            reader.onerror = () => {
                showError('讀取檔案時發生錯誤。');
                uploadedImages[index] = null;
                checkAllImagesUploaded();
            };

            reader.readAsDataURL(file);
        }

        // 檢查 8 張圖是否都上傳了
        function checkAllImagesUploaded() {
            const allUploaded = uploadedImages.every(img => img !== null);
            document.getElementById('generate-btn').disabled = !allUploaded;
        }

        // --- 遊戲邏輯 ---

        // 按下 "產生遊戲" 按鈕
        function generateGame() {
            // 1. 計算 8 x 4 = 32 種組合
            cardCombinations = [];
            for (let i = 0; i < 8; i++) { // 8 張圖
                for (let s = 0; s < SIZES.length; s++) { // 4 種大小
                    cardCombinations.push({ 
                        imageIndex: i, 
                        sizeIndex: s
                    });
                }
            }
            
            // 2. 產生兩份並洗牌
            const uniqueCards = [...cardCombinations];
            cardCombinations = [...uniqueCards, ...uniqueCards]; // 複製兩份，總共 64 張
            shuffleArray(cardCombinations); // 隨機排序 64 張卡片
            
            // console.log(`產生了 ${cardCombinations.length} 種組合`);

            // 3. 切換介面
            document.getElementById('upload-section').classList.add('hidden');
            document.getElementById('play-section').classList.remove('hidden');

            // 4. 預先載入骰子區 (圖案1 + 超大)
            document.getElementById('dice-image').innerHTML = `<img src="${uploadedImages[0]}" class="w-full h-full object-contain rounded-md" alt="圖案骰">`;
            document.getElementById('dice-size').innerHTML = `<span class="text-2xl md:text-4xl font-bold">${SIZES[0].name}</span>`;
        }

        // 按下 "擲骰" 按鈕
        function rollDice() {
            if (isRolling) return;
            isRolling = true;

            const diceImageEl = document.getElementById('dice-image');
            const diceSizeEl = document.getElementById('dice-size');
            
            const rollButton = document.querySelector('button[onclick="rollDice()"]');
            rollButton.disabled = true;
            rollButton.textContent = '擲骰中...';

            // 1. 開始旋轉
            [diceImageEl, diceSizeEl].forEach((diceEl) => {
                diceEl.innerHTML = `<span>?</span>`; // 顯示問號
                diceEl.classList.remove('dice-land');
                diceEl.classList.add('dice-spinning');
            });

            // 2. 設定 1.5 秒後顯示結果
            setTimeout(() => {
                // 取得隨機圖案 (D8)
                const randomImageIndex = Math.floor(Math.random() * 8);
                const randomImage = uploadedImages[randomImageIndex];
                
                // 取得隨機大小 (D4)
                const randomSizeIndex = Math.floor(Math.random() * 4);
                const randomSize = SIZES[randomSizeIndex];

                // 停止旋轉並顯示結果
                diceImageEl.classList.remove('dice-spinning');
                diceImageEl.innerHTML = `<img src="${randomImage}" class="w-full h-full object-contain rounded-md" alt="圖案骰結果">`;
                
                diceSizeEl.classList.remove('dice-spinning');
                diceSizeEl.innerHTML = `<span class="text-2xl md:text-4xl font-bold">${randomSize.name}</span>`;
                
                // 增加 "落地" 動畫效果
                [diceImageEl, diceSizeEl].forEach(diceEl => {
                    diceEl.classList.remove('dice-land');
                    void diceEl.offsetWidth; // 觸發重繪
                    diceEl.classList.add('dice-land');
                });


                // 3. 恢復按鈕
                rollButton.disabled = false;
                rollButton.textContent = '擲骰！';
                isRolling = false;
            }, 1500); // 1.5 秒
        }

        // --- PDF 產生 ---

        // 按下 "下載 PDF" 按鈕
        async function downloadPDF() {
            showLoading(true, '正在產生 PDF 檔案，64 張卡片，請稍候...');
            hideError(); 

            // 取得 "顯示文字" 選項
            const showText = document.getElementById('show-text-on-card').checked;

            try {
                const doc = new jsPDF('p', 'mm', 'a4'); // 縱向, 單位 mm, A4 尺寸
                const cardContainer = document.getElementById('card-print-area');
                
                const cardsPerPage = 8; // 2x4
                const numPages = Math.ceil(cardCombinations.length / cardsPerPage); // 64 / 8 = 8 頁
                
                const a4Width = 210;
                const a4Height = 297;

                for (let p = 0; p < numPages; p++) {
                    // 1. 取得這一頁的卡片組合
                    const pageSlice = cardCombinations.slice(p * cardsPerPage, (p + 1) * cardsPerPage);
                    
                    // 2. 產生這一頁的 HTML
                    let pageHtml = `<div class="pdf-page">`;
                    for (const combo of pageSlice) {
                        const imageUrl = uploadedImages[combo.imageIndex];
                        const size = SIZES[combo.sizeIndex];

                        let textHtml = '';
                        if (showText) {
                            textHtml = `<div class="pdf-card-text-wrapper"><span>${size.name}</span></div>`;
                        }

                        // 如果不顯示文字，新增 inline-style 來置中圖片
                        const cardStyle = showText ? '' : 'style="justify-content: center;"';

                        pageHtml += `
                            <div class="pdf-card" ${cardStyle}>
                                <div class="pdf-card-img-wrapper">
                                    <img src="${imageUrl}" alt="圖案" style="transform: scale(${size.scale});">
                                </div>
                                ${textHtml}
                            </div>
                        `;
                    }
                    pageHtml += `</div>`;
                    
                    cardContainer.innerHTML = pageHtml;
                    
                    // 3. 取得要轉換的 HTML 元素
                    const pageElement = cardContainer.querySelector('.pdf-page');

                    // 4. 使用 html2canvas 將 HTML 轉為 Canvas (提高 scale 增加解析度)
                    const canvas = await html2canvas(pageElement, {
                        scale: 3, // 提高解析度
                        useCORS: true 
                    });
                    
                    const imgData = canvas.toDataURL('image/png');

                    // 5. 將 Canvas 圖片加入 PDF
                    if (p > 0) {
                        doc.addPage();
                    }

                    const imgWidth = a4Width;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;

                    doc.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight); 
                }

                // 6. 儲存 PDF (使用 Blob 修正行動裝置下載問題)
                showLoading(true, '正在準備下載...');

                const pdfBlob = doc.output('blob');
                const blobUrl = URL.createObjectURL(pdfBlob);

                const link = document.createElement('a');
                link.href = blobUrl;
                link.download = 'WuSanBuChengLi-Game-Cards.pdf'; // 檔案名稱
                
                document.body.appendChild(link);
                link.click();
                
                document.body.removeChild(link);
                URL.revokeObjectURL(blobUrl);

            } catch (err) {
                console.error("PDF 產生失敗:", err);
                showError('產生 PDF 時發生錯誤。請再試一次。');
            } finally {
                // 7. 清理
                showLoading(false); // 隱藏 loading
                document.getElementById('card-print-area').innerHTML = '';
            }
        }


        // --- 輔助功能 (訊息提示) ---
        function showError(message) {
            document.getElementById('error-text').textContent = message;
            document.getElementById('error-message').classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('error-message').classList.add('hidden');
        }

        function showLoading(isLoading, message = '正在產生 PDF 檔案，64 張卡片，請稍候...') {
            document.getElementById('loading-text').textContent = message;
            document.getElementById('loading-message').classList.toggle('hidden', !isLoading);
        }

    </script>
</body>
</html>
